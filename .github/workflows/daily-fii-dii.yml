name: Daily FII/DII Data Collection

on:
  schedule:
    # Runs at 6:30 PM IST (1:00 PM UTC) on weekdays
    - cron: '0 13 * * 1-5'
  workflow_dispatch: # Allows manual trigger

jobs:
  collect-fii-dii-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Collect FII/DII Data
        run: |
          echo "üïê Starting FII/DII data collection..."
          
          # Ensure URL has https:// and proper format
          VERCEL_URL="${{ secrets.VERCEL_APP_URL }}"
          
          # Add https if not present
          if [[ ! "$VERCEL_URL" =~ ^https?:// ]]; then
            VERCEL_URL="https://$VERCEL_URL"
          fi
          
          # Remove trailing slash if present
          VERCEL_URL="${VERCEL_URL%/}"
          
          echo "üì° Calling: $VERCEL_URL/api/cron/daily-fii-dii"
          
          # Call the endpoint with follow redirects and better error handling
          response=$(curl -L -s -w "\n%{http_code}" -X POST \
            "$VERCEL_URL/api/cron/daily-fii-dii" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-FII-DII-Collector" \
            --max-time 30 \
            --retry 2)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "üìä Response Body: $body"
          echo "üî¢ HTTP Code: $http_code"
          
          # Also try GET method if POST fails
          if [ "$http_code" -eq 308 ] || [ "$http_code" -eq 405 ]; then
            echo "üîÑ Trying GET method instead..."
            response=$(curl -L -s -w "\n%{http_code}" -X GET \
              "$VERCEL_URL/api/cron/daily-fii-dii" \
              -H "User-Agent: GitHub-Actions-FII-DII-Collector" \
              --max-time 30)
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n -1)
            
            echo "üìä GET Response Body: $body"
            echo "üî¢ GET HTTP Code: $http_code"
          fi
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ FII/DII data collection successful!"
          else
            echo "‚ùå FII/DII data collection failed!"
            echo "üêõ Debug info:"
            echo "   URL used: $VERCEL_URL/api/cron/daily-fii-dii"
            echo "   HTTP Code: $http_code"
            echo "   Response: $body"
            exit 1
          fi 