name: Intraday Signals Scanner

on:
  # Run every 5 minutes from 9:25 AM to 10:25 AM IST (3:55 AM to 4:55 AM UTC)
  schedule:
    - cron: '55,0,5,10,15,20,25,30,35,40,45,50,55 3 * * 1-5'  # 3:55 AM to 3:55 AM UTC (next hour)
    - cron: '0,5,10,15,20,25,30,35,40,45,50,55 4 * * 1-5'     # 4:00 AM to 4:55 AM UTC
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even outside market hours'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  scan-intraday-signals:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🚀 Starting Intraday Signals Scan
        run: |
          echo "⏰ Starting intraday signals scan at $(date)"
          echo "🌍 Current UTC time: $(date -u)"
          echo "🇮🇳 Current IST time: $(TZ=Asia/Kolkata date)"
          
      - name: 📊 Scan ChartInk for Intraday Signals
        id: scan_signals
        run: |
          # Determine the API URL
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            API_URL="${{ secrets.NEXTJS_APP_URL || 'https://tradesmartmoney.vercel.app' }}/api/intraday-signals?force=true"
            echo "🔧 Manual trigger with force=true"
          else
            API_URL="${{ secrets.NEXTJS_APP_URL || 'https://tradesmartmoney.vercel.app' }}/api/intraday-signals"
            echo "⏰ Scheduled run - checking time window"
          fi
          
          echo "📡 Calling API: $API_URL"
          
          # Make the API call
          RESPONSE=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-IntraDay-Scanner/1.0" \
            -w "\nHTTP_STATUS:%{http_code}")
          
          # Extract HTTP status
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
          
          echo "📈 Response Status: $HTTP_STATUS"
          echo "📄 Response Body: $RESPONSE_BODY"
          
          # Check if the request was successful
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Intraday signals scan completed successfully!"
            
            # Try to extract signal count from response
            SIGNAL_COUNT=$(echo "$RESPONSE_BODY" | grep -o '"signalsCount":[0-9]*' | cut -d: -f2 || echo "unknown")
            echo "🎯 Signals processed: $SIGNAL_COUNT"
            
            # Set output for later steps
            echo "success=true" >> $GITHUB_OUTPUT
            echo "signal_count=$SIGNAL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "❌ Intraday signals scan failed with status: $HTTP_STATUS"
            echo "📋 Response: $RESPONSE_BODY"
            
            # Check if it's just outside time window (not a real error)
            if echo "$RESPONSE_BODY" | grep -q "Scanning only active between"; then
              echo "⏰ Outside scanning time window - this is normal"
              echo "success=skipped" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: 🔔 Notify on Success
        if: steps.scan_signals.outputs.success == 'true'
        run: |
          echo "🎉 Intraday signals successfully updated!"
          echo "📊 Processed ${{ steps.scan_signals.outputs.signal_count }} signals"
          echo "⏰ Completed at: $(TZ=Asia/Kolkata date)"
          
      - name: 🔔 Notify on Skip
        if: steps.scan_signals.outputs.success == 'skipped'
        run: |
          echo "⏰ Scan skipped - outside market hours (9:25-10:25 AM IST)"
          echo "🕐 Current IST time: $(TZ=Asia/Kolkata date)"
          
      - name: ❌ Notify on Failure
        if: steps.scan_signals.outputs.success == 'false'
        run: |
          echo "❌ Intraday signals scan failed!"
          echo "🕐 Failed at: $(TZ=Asia/Kolkata date)"
          echo "🚨 Please check the logs above for error details"
          
          # Post to Slack/Discord if webhook URL is set (optional)
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "content": "🚨 **TradeSmart Money Alert**\n❌ Intraday signals scan failed at $(TZ=Asia/Kolkata date)\n🔗 Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }'
          fi

      - name: 📊 Job Summary
        if: always()
        run: |
          echo "## 📊 Intraday Signals Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(TZ=Asia/Kolkata date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.scan_signals.outputs.success }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.scan_signals.outputs.success }}" = "true" ]; then
            echo "- **Signals Processed**: ${{ steps.scan_signals.outputs.signal_count }}" >> $GITHUB_STEP_SUMMARY
            echo "✅ Scan completed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.scan_signals.outputs.success }}" = "skipped" ]; then
            echo "⏰ Scan skipped - outside market hours" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Scan failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- View signals: [https://www.tradesmartmoney.com](https://www.tradesmartmoney.com)" >> $GITHUB_STEP_SUMMARY
          echo "- API endpoint: [/api/intraday-signals](https://www.tradesmartmoney.com/api/intraday-signals)" >> $GITHUB_STEP_SUMMARY

# ==========================================
# CONFIGURATION NOTES
# ==========================================

# Time Zones:
# - IST (India Standard Time) = UTC + 5:30
# - 9:25 AM IST = 3:55 AM UTC
# - 10:25 AM IST = 4:55 AM UTC

# Cron Schedule Explanation:
# - Runs every 5 minutes from 3:55 AM to 4:55 AM UTC
# - This covers 9:25 AM to 10:25 AM IST (market opening hour)
# - Only runs on weekdays (Monday-Friday)

# Required Secrets:
# - NEXT_PUBLIC_SUPABASE_URL (set in repository secrets)
# - SUPABASE_SERVICE_ROLE_KEY (set in repository secrets)
# - NEXTJS_APP_URL (optional, defaults to Vercel URL)
# - DISCORD_WEBHOOK_URL (optional, for failure notifications)

# Manual Testing:
# - Go to GitHub Actions tab
# - Click "Intraday Signals Scanner"
# - Click "Run workflow"
# - Select "force_run: true" to test outside market hours 